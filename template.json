{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "esg_image_name": {
            "defaultValue": "85_2376",
            "type": "string"
        },
        "virtualNetworks_ESG1_name": {
            "defaultValue": "ESG1",
            "type": "string"
        },
        "storageAccounts_esg1_name": {
            "defaultValue": "emaildev",
            "type": "string"
        },
        "publicIPAddresses_lbip_name": {
            "defaultValue": "lbip",
            "type": "string"
        },
        "vm_name": {
            "defaultValue": "esg-vm",
            "type": "string"
        },
        "numberOfVMs" : {
            "defaultvalue": 3,
            "type": "int"
        },
        "networkInterfaces_Pinterface_name": {
            "defaultValue": "Pinterface",
            "type": "string"
        },
        "loadBalancers_esgLoadBalancer_name": {
            "defaultValue": "esgLoadBalancer",
            "type": "string"
        },
        "networkInterfaces_vm_name": {
            "defaultValue": "nic-esg-vm",
            "type": "string"
        },
        "publicIPAddresses_vm_name": {
            "defaultValue": "public-ip-esg-vm",
            "type": "string"
        },
        "availabilitySets_ESG1AvailabilitySet_name": {
            "defaultValue": "ESG1AvailabilitySet",
            "type": "string"
        },
        "publicIPAddresses_esg1gatewaypublicIP_name": {
            "defaultValue": "esg1gatewaypublicIP",
            "type": "string"
        },
        "virtualNetworkGateways_VNetGatewayESG1_name": {
            "defaultValue": "VNetGatewayESG1",
            "type": "string"
        },
        "subnets_ESG1Subnet_name": {
            "defaultValue": "ESG1Subnet",
            "type": "string"
        },
        "subnets_ESG2Subnet_name": {
            "defaultValue": "ESG2Subnet",
            "type": "string"
        },
        "subnets_GatewaySubnet_name": {
            "defaultValue": "GatewaySubnet",
            "type": "string"
        },
        "networkSecurityGroups_VPNNSG_name": {
            "defaultValue": "VPNNSG",
            "type": "String"
        },
        "securityRules_Port_22_name": {
            "defaultValue": "Port_22",
            "type": "String"
        },
        "securityRules_Port_80_name": {
            "defaultValue": "Port_80",
            "type": "String"
        },
        "securityRules_Port_443_name": {
            "defaultValue": "Port_443",
            "type": "String"
        },
        "securityRules_Port_6671_name": {
            "defaultValue": "Port_6671",
            "type": "String"
        },
        "securityRules_Port_1433_name": {
            "defaultValue": "Port_1433",
            "type": "String"
        },
        "securityRules_Port_9449_name": {
            "defaultValue": "Port_9449",
            "type": "String"
        },
        "securityRules_Port_50800_name": {
            "defaultValue": "Port_50800",
            "type": "String"
        },
        "securityRules_Port_443_out_name": {
            "defaultValue": "Port_443_out",
            "type": "String"
        },
        "securityRules_Port_6671_out_name": {
            "defaultValue": "Port_6671_out",
            "type": "String"
        },
        "securityRules_Port_1433_out_name": {
            "defaultValue": "Port_1433_out",
            "type": "String"
        }
    },
    "variables": {},
    "resources": [
        {
            "comments": "Generalized from resource: '/subscriptions/ee4f28c5-8b36-4e60-bae1-b37a145063f7/resourceGroups/ESG1/providers/Microsoft.Network/virtualNetworks/ESG1'.",
            "type": "Microsoft.Network/virtualNetworks",
            "name": "[parameters('virtualNetworks_ESG1_name')]",
            "apiVersion": "2017-06-01",
            "location": "centralus",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "resourceGuid": "e199a6d8-4dd1-4ee3-a7c4-937c52d2f66c",
                "addressSpace": {
                    "addressPrefixes": [
                        "193.168.0.0/16"
                    ]
                },
                "subnets": [
                    {
                        "name": "[concat(parameters('virtualNetworks_ESG1_name'),'Subnet')]",
                        "etag": "W/\"81e18364-b3ba-427e-aca1-9102e40c4744\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "193.168.1.0/24",
                            "networkSecurityGroup": {
                                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', 'neilVPNSecurityGroup')]"
                            }
                        }
                    },
                    {
                        "name": "GatewaySubnet",
                        "etag": "W/\"81e18364-b3ba-427e-aca1-9102e40c4744\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "193.168.0.0/24"
                        }
                    },
                    {
                        "name": "[parameters('subnets_ESG2Subnet_name')]",
                        "etag": "W/\"81e18364-b3ba-427e-aca1-9102e40c4744\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "addressPrefix": "193.168.3.0/24"
                        }
                    }
                ],
                "virtualNetworkPeerings": []
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/cddb4853-ab74-4260-9e13-1a54d67a0385/resourceGroups/network-test/providers/Microsoft.Network/networkSecurityGroups/VPNNSG'.",
            "type": "Microsoft.Network/networkSecurityGroups",
            "name": "[parameters('networkSecurityGroups_VPNNSG_name')]",
            "apiVersion": "2017-06-01",
            "location": "centralus",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "resourceGuid": "85a0441e-3b1d-416d-9b22-2cf3520efd05",
                "securityRules": [
                    {
                        "name": "Port_22",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "destinationPortRange": "22",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 100,
                            "direction": "Inbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "Port_6671",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "6671",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 200,
                            "direction": "Inbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "Port_1433",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "1433",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 300,
                            "direction": "Inbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "Port_17700_17715",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "17700-17715",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 500,
                            "direction": "Inbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "Port_9449",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "9449",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 400,
                            "direction": "Inbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "Port_443",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "443",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 600,
                            "direction": "Inbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "Port_6671_out",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "6671",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 100,
                            "direction": "Outbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "Port_50800",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "50800",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 200,
                            "direction": "Outbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "Port_1433_out",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "1433",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 300,
                            "direction": "Outbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "Port_80",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "80",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 500,
                            "direction": "Outbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "Port_443_out",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "443",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 600,
                            "direction": "Outbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    }
                ],
                "defaultSecurityRules": [
                    {
                        "name": "AllowVnetInBound",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "description": "Allow inbound traffic from all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Inbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "AllowAzureLoadBalancerInBound",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "description": "Allow inbound traffic from azure load balancer",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "AzureLoadBalancer",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Inbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "DenyAllInBound",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "description": "Deny all inbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Inbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "AllowVnetOutBound",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "description": "Allow outbound traffic from all VMs to all VMs in VNET",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "VirtualNetwork",
                            "destinationAddressPrefix": "VirtualNetwork",
                            "access": "Allow",
                            "priority": 65000,
                            "direction": "Outbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "AllowInternetOutBound",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "description": "Allow outbound traffic from all VMs to Internet",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "Internet",
                            "access": "Allow",
                            "priority": 65001,
                            "direction": "Outbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "DenyAllOutBound",
                        "etag": "W/\"53e94ed5-7978-42d3-b4dd-5be5c89dd379\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "description": "Deny all outbound traffic",
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Deny",
                            "priority": 65500,
                            "direction": "Outbound",
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    }
                ]
            },
            "dependsOn": []
        },
        {
            "comments": "Generalized from resource: '/subscriptions/cddb4853-ab74-4260-9e13-1a54d67a0385/resourceGroups/network-test/providers/Microsoft.Network/networkSecurityGroups/VPNNSG/securityRules/Port_22'.",
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "name": "[concat(parameters('networkSecurityGroups_VPNNSG_name'), '/', parameters('securityRules_Port_22_name'))]",
            "apiVersion": "2017-06-01",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "protocol": "TCP",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 100,
                "direction": "Inbound",
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/cddb4853-ab74-4260-9e13-1a54d67a0385/resourceGroups/network-test/providers/Microsoft.Network/networkSecurityGroups/VPNNSG/securityRules/Port_6671'.",
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "name": "[concat(parameters('networkSecurityGroups_VPNNSG_name'), '/', parameters('securityRules_Port_6671_name'))]",
            "apiVersion": "2017-06-01",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "6671",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 200,
                "direction": "Inbound",
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/cddb4853-ab74-4260-9e13-1a54d67a0385/resourceGroups/network-test/providers/Microsoft.Network/networkSecurityGroups/VPNNSG/securityRules/Port_1433'.",
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "name": "[concat(parameters('networkSecurityGroups_VPNNSG_name'), '/', parameters('securityRules_Port_1433_name'))]",
            "apiVersion": "2017-06-01",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "1433",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 300,
                "direction": "Inbound",
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/cddb4853-ab74-4260-9e13-1a54d67a0385/resourceGroups/network-test/providers/Microsoft.Network/networkSecurityGroups/VPNNSG/securityRules/Port_9449'.",
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "name": "[concat(parameters('networkSecurityGroups_VPNNSG_name'), '/', parameters('securityRules_Port_9449_name'))]",
            "apiVersion": "2017-06-01",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "9449",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 400,
                "direction": "Inbound",
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/cddb4853-ab74-4260-9e13-1a54d67a0385/resourceGroups/network-test/providers/Microsoft.Network/networkSecurityGroups/VPNNSG/securityRules/Port_443'.",
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "name": "[concat(parameters('networkSecurityGroups_VPNNSG_name'), '/', parameters('securityRules_Port_443_name'))]",
            "apiVersion": "2017-06-01",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 600,
                "direction": "Inbound",
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/cddb4853-ab74-4260-9e13-1a54d67a0385/resourceGroups/network-test/providers/Microsoft.Network/networkSecurityGroups/VPNNSG/securityRules/Port_6671_out'.",
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "name": "[concat(parameters('networkSecurityGroups_VPNNSG_name'), '/', parameters('securityRules_Port_6671_out_name'))]",
            "apiVersion": "2017-06-01",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "6671",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 100,
                "direction": "Outbound",
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/cddb4853-ab74-4260-9e13-1a54d67a0385/resourceGroups/network-test/providers/Microsoft.Network/networkSecurityGroups/VPNNSG/securityRules/Port_50800'.",
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "name": "[concat(parameters('networkSecurityGroups_VPNNSG_name'), '/', parameters('securityRules_Port_50800_name'))]",
            "apiVersion": "2017-06-01",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "50800",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 200,
                "direction": "Outbound",
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/cddb4853-ab74-4260-9e13-1a54d67a0385/resourceGroups/network-test/providers/Microsoft.Network/networkSecurityGroups/VPNNSG/securityRules/Port_1433_out'.",
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "name": "[concat(parameters('networkSecurityGroups_VPNNSG_name'), '/', parameters('securityRules_Port_1433_out_name'))]",
            "apiVersion": "2017-06-01",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "1433",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 300,
                "direction": "Outbound",
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/cddb4853-ab74-4260-9e13-1a54d67a0385/resourceGroups/network-test/providers/Microsoft.Network/networkSecurityGroups/VPNNSG/securityRules/Port_80'.",
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "name": "[concat(parameters('networkSecurityGroups_VPNNSG_name'), '/', parameters('securityRules_Port_80_name'))]",
            "apiVersion": "2017-06-01",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "80",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 500,
                "direction": "Outbound",
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/cddb4853-ab74-4260-9e13-1a54d67a0385/resourceGroups/network-test/providers/Microsoft.Network/networkSecurityGroups/VPNNSG/securityRules/Port_443_out'.",
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "name": "[concat(parameters('networkSecurityGroups_VPNNSG_name'), '/', parameters('securityRules_Port_443_out_name'))]",
            "apiVersion": "2017-06-01",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 600,
                "direction": "Outbound",
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
            ]
        },
        
        {
            "comments": "Generalized from resource: '/subscriptions/ee4f28c5-8b36-4e60-bae1-b37a145063f7/resourceGroups/ESG1/providers/Microsoft.Compute/availabilitySets/ESG1AvailabilitySet'.",
            "type": "Microsoft.Compute/availabilitySets",
            "sku": {
                "name": "Aligned"
            },
            "name": "[parameters('availabilitySets_ESG1AvailabilitySet_name')]",
            "apiVersion": "2016-04-30-preview",
            "location": "centralus",
            "tags": {},
            "scale": null,
            "properties": {
                "platformUpdateDomainCount": 5,
                "platformFaultDomainCount": 2,
                "virtualMachines": [
                ]
            },
            "dependsOn": [
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/ee4f28c5-8b36-4e60-bae1-b37a145063f7/resourceGroups/ESG1/providers/Microsoft.Compute/images/85_2376'.",
            "type": "Microsoft.Compute/images",
            "name": "[parameters('esg_image_name')]",
            "apiVersion": "2016-04-30-preview",
            "location": "centralus",
            "scale": null,
            "properties": {
                "storageProfile": {
                    "osDisk": {
                        "osType": "Linux",
                        "osState": "Generalized",
                        "diskSizeGB": 101,
                        "blobUri": "[concat('https', '://', parameters('storageAccounts_esg1_name'), '.blob.core.windows.net', concat('/esg1/Appliance_Main_', parameters('esg_image_name'),'.vhd'))]",
                        "caching": "ReadWrite",
                        "storageAccountType": "Standard_LRS"
                    },
                    "dataDisks": [
                        {
                            "lun": 0,
                            "diskSizeGB": 100,
                            "blobUri": "[concat('https', '://', parameters('storageAccounts_esg1_name'), '.blob.core.windows.net', concat('/esg1/DataDisk.vhd'))]",
                            "caching": "ReadWrite",
                            "storageAccountType": "Standard_LRS"
                        }
                    ]
                }
            }
        },        
        {
            "comments": "Generalized from resource: '/subscriptions/ee4f28c5-8b36-4e60-bae1-b37a145063f7/resourceGroups/ESG1/providers/Microsoft.Compute/virtualMachines/ESG-2376-001'.",
            "type": "Microsoft.Compute/virtualMachines",
            "name": "[concat(parameters('vm_name'), copyIndex(1))]",
            "apiVersion": "2016-04-30-preview",
            "location": "centralus",
            "tags": {},
            "scale": null,
            "copy" : {
                "name": "virtualmachines",
                "count": "[parameters('numberOfVMs')]"
            },
            "properties": {
                 "availabilitySet": {
                    "id": "[resourceId('Microsoft.Compute/availabilitySets', parameters('availabilitySets_ESG1AvailabilitySet_name'))]"
                },
                "hardwareProfile": {
                    "vmSize": "Standard_A3"
                },
                "storageProfile": {
                    "imageReference": {
                        "id": "[resourceId('Microsoft.Compute/images', parameters('esg_image_name'))]"
                    }
                },
                "osProfile": {
                    "computerName": "[concat(parameters('vm_name'), copyIndex(1))]",
                    "adminUsername": "azureuser",
                    "adminPassword": "websense#123",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": false
                    },
                    "secrets": []
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('networkInterfaces_vm_name'), copyIndex(1)))]",
                            "properties": {
                                "primary": true
                            }
                        },
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('networkInterfaces_Pinterface_name'), copyIndex(1)))]",
                            "properties": {
                                "primary": false
                            }
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true,
                        "storageUri": "https://emaildevdiag637.blob.core.windows.net/"
                    }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Compute/images', parameters('esg_image_name'))]",
                "[resourceId('Microsoft.Compute/availabilitySets', parameters('availabilitySets_ESG1AvailabilitySet_name'))]",
                "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('networkInterfaces_vm_name'), copyIndex(1)))]",
                "[resourceId('Microsoft.Network/networkInterfaces', concat(parameters('networkInterfaces_Pinterface_name'), copyIndex(1)))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/ee4f28c5-8b36-4e60-bae1-b37a145063f7/resourceGroups/ESG1/providers/Microsoft.Network/loadBalancers/esgLoadBalancer'.",
            "type": "Microsoft.Network/loadBalancers",
            "name": "[parameters('loadBalancers_esgLoadBalancer_name')]",
            "apiVersion": "2017-06-01",
            "location": "centralus",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "resourceGuid": "8a484e12-efd9-408a-a41b-c1885e7a76ed",
                "frontendIPConfigurations": [
                    {
                        "name": "LoadBalancerFrontEnd",
                        "etag": "W/\"d4e2859b-9b22-4f7c-a5d3-b202a051caa7\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIPAddresses_lbip_name'))]"
                            }
                        }
                    }
                ],
                "backendAddressPools": [
                    {
                        "name": "ESG1Backpool",
                        "etag": "W/\"d4e2859b-9b22-4f7c-a5d3-b202a051caa7\"",
                        "properties": {
                            "provisioningState": "Succeeded"
                        }
                    }
                ],
                "loadBalancingRules": [],
                "probes": [
                    {
                        "name": "ESG1HP",
                        "etag": "W/\"d4e2859b-9b22-4f7c-a5d3-b202a051caa7\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "protocol": "Tcp",
                            "port": 25,
                            "intervalInSeconds": 5,
                            "numberOfProbes": 2
                        }
                    }
                ],
                "inboundNatRules": [],
                "outboundNatRules": [],
                "inboundNatPools": []
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIPAddresses_lbip_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/ee4f28c5-8b36-4e60-bae1-b37a145063f7/resourceGroups/ESG1/providers/Microsoft.Network/publicIPAddresses/ESG-2376-001-ip'.",
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[concat(parameters('publicIPAddresses_vm_name'), copyIndex(1))]",
            "apiVersion": "2017-06-01",
            "location": "centralus",
            "scale": null,
            "copy" : {
                "name": "vmpublicips",
                "count": "[parameters('numberOfVMs')]"
            },
            "properties": {
                "provisioningState": "Succeeded",
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Dynamic",
                "idleTimeoutInMinutes": 4
            },
            "dependsOn": []
        },
        {
            "comments": "Generalized from resource: '/subscriptions/ee4f28c5-8b36-4e60-bae1-b37a145063f7/resourceGroups/ESG1/providers/Microsoft.Network/publicIPAddresses/esg1gatewaypublicIP'.",
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[parameters('publicIPAddresses_esg1gatewaypublicIP_name')]",
            "apiVersion": "2017-06-01",
            "location": "centralus",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "resourceGuid": "fb135fdd-335f-45fc-a923-8e42ee15500e",
                "ipAddress": "52.176.157.66",
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Dynamic",
                "idleTimeoutInMinutes": 4
            },
            "dependsOn": []
        },
        {
            "comments": "Generalized from resource: '/subscriptions/ee4f28c5-8b36-4e60-bae1-b37a145063f7/resourceGroups/ESG1/providers/Microsoft.Network/publicIPAddresses/lbip'.",
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[parameters('publicIPAddresses_lbip_name')]",
            "apiVersion": "2017-06-01",
            "location": "centralus",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "resourceGuid": "a72fb50f-0f6e-446c-8739-8a1b4cccee9a",
                "ipAddress": "52.173.139.236",
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 4
            },
            "dependsOn": []
        },
           {
            "comments": "Generalized from resource: '/subscriptions/ee4f28c5-8b36-4e60-bae1-b37a145063f7/resourceGroups/ESG1/providers/Microsoft.Network/networkInterfaces/esg-2376-00186'.",
            "type": "Microsoft.Network/networkInterfaces",
            "name": "[concat(parameters('networkInterfaces_vm_name'), copyIndex(1))]",
            "apiVersion": "2017-06-01",
            "location": "centralus",
            "scale": null,
            "copy" : {
                "name": "nic-interfaces",
                "count": "[parameters('numberOfVMs')]" 
            },
            "properties": {
                "provisioningState": "Succeeded",
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "etag": "W/\"ebec2a24-7e6f-4e72-af77-8ca31e91c7a7\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', concat(parameters('publicIPAddresses_vm_name'), copyIndex(1)))]"
                            },
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_ESG1_name'), parameters('subnets_ESG1Subnet_name'))]"
                            },
                            "primary": true,
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "dnsSettings": {
                    "dnsServers": [],
                    "appliedDnsServers": [],
                    "internalDomainNameSuffix": "1ctjtyorjxru3j4esn4ffuxwne.gx.internal.cloudapp.net"
                },
                "enableAcceleratedNetworking": false,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
                },
                "primary": true,
                "virtualMachine": {
                    "id": "[resourceId('Microsoft.Compute/virtualMachines', concat(parameters('vm_name'), copyIndex(1)))]"
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', concat(parameters('publicIPAddresses_vm_name'), copyIndex(1)))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_ESG1_name'), parameters('subnets_ESG1Subnet_name'))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/ee4f28c5-8b36-4e60-bae1-b37a145063f7/resourceGroups/ESG1/providers/Microsoft.Network/networkInterfaces/Pinterface'.",
            "type": "Microsoft.Network/networkInterfaces",
            "name": "[concat(parameters('networkInterfaces_Pinterface_name'), copyIndex(1))]",
            "apiVersion": "2017-06-01",
            "location": "centralus",
            "scale": null,
            "copy" : {
                "name":"pinterfaces",
                "count": "[parameters('numberOfVMs')]"
            },
            "properties": {
                "provisioningState": "Succeeded",
                "resourceGuid": "61b6f003-37b2-4de3-8453-85fd886e7ec8",
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "etag": "W/\"d666783d-70e3-499e-ac0c-c3faf7115664\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_ESG1_name'), parameters('subnets_ESG1Subnet_name'))]"
                            },
                            "primary": true,
                            "privateIPAddressVersion": "IPv4",
                            "loadBalancerBackendAddressPools": [
                                {
                                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancers_esgLoadBalancer_name')), '/backendAddressPools/ESG1Backpool')]"
                                }
                            ]
                        }
                    }
                ],
                "dnsSettings": {
                    "dnsServers": [],
                    "appliedDnsServers": [],
                    "internalDomainNameSuffix": "1ctjtyorjxru3j4esn4ffuxwne.gx.internal.cloudapp.net"
                },
                "enableAcceleratedNetworking": false,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
                },
                "primary": false,
                "virtualMachine": {
                    "id": "[resourceId('Microsoft.Compute/virtualMachines', concat(parameters('vm_name'), copyIndex(1)))]"
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_ESG1_name'), parameters('subnets_ESG1Subnet_name'))]",
                "[resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancers_esgLoadBalancer_name'))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
            ]
        },
         {
            "comments": "Generalized from resource: '/subscriptions/ee4f28c5-8b36-4e60-bae1-b37a145063f7/resourceGroups/ESG1/providers/Microsoft.Network/virtualNetworkGateways/VNetGatewayESG1'.",
            "type": "Microsoft.Network/virtualNetworkGateways",
            "name": "[parameters('virtualNetworkGateways_VNetGatewayESG1_name')]",
            "apiVersion": "2017-06-01",
            "location": "centralus",
            "scale": null,
            "properties": {
                "resourceGuid": "11643302-03e9-4498-8964-0c1853246686",
                "ipConfigurations": [
                    {
                        "name": "default",
                        "etag": "W/\"79ce5726-dc29-4d7c-ba5c-32bb1855af60\"",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIPAddresses_esg1gatewaypublicIP_name'))]"
                            },
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_ESG1_name'), parameters('subnets_GatewaySubnet_name'))]"
                            }
                        }
                    }
                ],
                "sku": {
                    "name": "Standard",
                    "tier": "Standard",
                    "capacity": 2
                },
                "gatewayType": "Vpn",
                "vpnType": "RouteBased",
                "enableBgp": false,
                "activeActive": false,
                "vpnClientConfiguration": {
                    "vpnClientAddressPool": {
                        "addressPrefixes": [
                            "182.16.0.0/24"
                        ]
                    },
                    "vpnClientProtocols": [
                        "SSTP",
                        "IkeV2"
                    ],
                    "vpnClientRootCertificates": [
                        {
                            "name": "RootCert1",
                            "etag": "W/\"79ce5726-dc29-4d7c-ba5c-32bb1855af60\"",
                            "properties": {
                                "publicCertData": "MIIC7zCCAdegAwIBAgIQVBHUpmIs1IhDqergiU76fDANBgkqhkiG9w0BAQsFADAa MRgwFgYDVQQDDA9UQ0F6dXJlUm9vdENlcnQwHhcNMTcwNDA0MTU1OTQ0WhcNMTgw NDA0MTYxOTQ0WjAaMRgwFgYDVQQDDA9UQ0F6dXJlUm9vdENlcnQwggEiMA0GCSqG SIb3DQEBAQUAA4IBDwAwggEKAoIBAQDRKyJboLxaU7EC/p1FPQy1HNOqGi7Ymz+I 4zfxYegpT52HAzaOuxpQD69kYM9JdLU2cRLVNaG/M9WJdlHs8CcYJqmMAmMg3a/U gCW2vXNzhENbKiCHLdTwQZyN50IBQf7/VOd1sVdy9YRSOynarRPv1ehxX0MK4okJ K7MQ4dm/3NwMrwyf57IqzrAEZvWxz5/UD1gWwuPqYWYqYjKovIEROv+iG0iNmaz6 nZaJAXCV8HS7lNr6awBtq8swwka4ePYG8twMXXvcoMSOsMY6rq/YjB6bc4dGg5Td HYlyWazXg/eDvu1P7zDnbJ9uKfyNq4Uf4Lb+Kutk8e1fgrSrcA3VAgMBAAGjMTAv MA4GA1UdDwEB/wQEAwICBDAdBgNVHQ4EFgQUTz6CO8wg5zPFHtunGs4hOkdmiTQw DQYJKoZIhvcNAQELBQADggEBAB1z3d764RqZYh/A6RXZZs9vIYTH8RU4xg6NW4PS Es6/ks981L5cQjZ7U4gvYmlpeATiBO9cPbbEJaI43V2zsknfy3Fs+iCGe9HVw6lG 4WRggZvhEeCTrcjjfTrJ5MyZgzGNVqEFj3gALp3lD6Li15PDaTKHdGbYBxeIJEWQ 20FuMj2dkDCUZSkYeeViIv0kIO8lS0+Hog5iVygDT+mVqBFmwG/ow+thpAQtzkuO WFJwRR5gQ4h3PaGwiDQ8Wxt5o2UsO1ocEYC8A4VX6TnSzqjnDH1aIak/Aq+Wiiq4 +I0kbqPUdBAmwG1g5MMMGOJy2RabfpihNM6T1hCOoqJlhcc="
                            }
                        }
                    ],
                    "vpnClientRevokedCertificates": []
                },
                "bgpSettings": {
                    "asn": 65515,
                    "bgpPeeringAddress": "193.168.0.254",
                    "peerWeight": 0
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIPAddresses_esg1gatewaypublicIP_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_ESG1_name'), parameters('subnets_GatewaySubnet_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/ee4f28c5-8b36-4e60-bae1-b37a145063f7/resourceGroups/ESG1/providers/Microsoft.Network/virtualNetworks/ESG1/subnets/ESG1Subnet'.",
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "name": "[concat(parameters('virtualNetworks_ESG1_name'), '/', parameters('subnets_ESG1Subnet_name'))]",
            "apiVersion": "2017-06-01",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "addressPrefix": "193.168.1.0/24",
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworks_ESG1_name'))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_VPNNSG_name'))]"
            ]
        },
        {
            "comments": "Generalized from resource: '/subscriptions/ee4f28c5-8b36-4e60-bae1-b37a145063f7/resourceGroups/ESG1/providers/Microsoft.Network/virtualNetworks/ESG1/subnets/GatewaySubnet'.",
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "name": "[concat(parameters('virtualNetworks_ESG1_name'), '/', parameters('subnets_GatewaySubnet_name'))]",
            "apiVersion": "2017-06-01",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "addressPrefix": "193.168.0.0/24"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworks_ESG1_name'))]"
            ]
        }
    ]
}